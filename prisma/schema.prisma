generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String
  name                 String
  phone                String?
  position             String?
  organization         String?
  role                 String    @default("user") // "admin" or "user"
  emailVerified        Boolean   @default(true)
  emailVerifyToken     String?
  emailVerifyExpires   DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model RateLimit {
  id         String @id @default(cuid())
  ipAddress  String
  date       String // YYYY-MM-DD format for daily tracking
  clickCount Int    @default(0)

  @@unique([ipAddress, date])
}

// ============================================
// Basel Framework Models
// ============================================

// Standard categories (SCO, CAP, RBC, CRE, etc.)
model BaselStandard {
  id          String              @id @default(cuid())
  code        String              @unique // "SCO", "CAP", "RBC"
  name        String              // "Scope of application"
  description String?
  order       Int                 @default(0)
  chapters    BaselChapter[]
  pdfs        BaselStandardPDF[]  // Optional PDFs attached to standard
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

// PDFs attached to standards (optional, for downloadable documents)
model BaselStandardPDF {
  id         String        @id @default(cuid())
  name       String        // Display name (e.g., "Full Standard Document")
  url        String        // VPS URL
  filename   String?       // Filename for VPS deletion
  standardId String
  standard   BaselStandard @relation(fields: [standardId], references: [id], onDelete: Cascade)
  order      Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

// Chapters within a standard (SCO10, SCO30, CAP10, etc.)
model BaselChapter {
  id            String            @id @default(cuid())
  code          String            // "10", "30"
  title         String            // "Introduction", "Banking, securities..."
  standardId    String
  standard      BaselStandard     @relation(fields: [standardId], references: [id], onDelete: Cascade)
  effectiveDate DateTime?
  lastUpdate    DateTime?
  status        String            @default("current") // "current", "archived"
  order         Int               @default(0)
  sections      BaselSection[]
  pdfs          BaselChapterPDF[] // Optional PDFs attached to chapter
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([standardId, code])
}

// PDFs attached to chapters (optional, for downloadable documents)
model BaselChapterPDF {
  id        String       @id @default(cuid())
  name      String       // Display name (e.g., "Basel III Framework")
  url       String       // VPS URL
  publicId  String?      // Legacy: Cloudinary public_id for old files
  filename  String?      // Filename for VPS deletion
  chapterId String
  chapter   BaselChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  order     Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

// Sections within a chapter (e.g., "Consolidation", "General requirements")
model BaselSection {
  id          String            @id @default(cuid())
  title       String            // "Consolidation"
  chapterId   String
  chapter     BaselChapter      @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  order       Int               @default(0)
  subsections BaselSubsection[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

// Subsections (SCO30.1, SCO30.2, etc.) - the actual content paragraphs
model BaselSubsection {
  id                 String          @id @default(cuid())
  number             String          // "30.1", "30.2"
  content            String          @db.Text // Rich text JSON with references/tooltips
  betterBankingNotes String?         @db.Text // Summary notes by BetterBanking
  sectionId          String
  section            BaselSection    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order              Int             @default(0)
  footnotes          BaselFootnote[]
  faqs               BaselFAQ[]
  revisions          BaselRevision[] // Previous revisions of this subsection
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@unique([sectionId, number])
}

// Footnotes attached to subsections
model BaselFootnote {
  id           String          @id @default(cuid())
  number       Int
  content      String          @db.Text
  subsectionId String
  subsection   BaselSubsection @relation(fields: [subsectionId], references: [id], onDelete: Cascade)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

// FAQs attached to subsections
model BaselFAQ {
  id           String          @id @default(cuid())
  question     String
  answer       String          @db.Text
  subsectionId String
  subsection   BaselSubsection @relation(fields: [subsectionId], references: [id], onDelete: Cascade)
  order        Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

// Previous revisions of subsections (for tracking historical changes)
model BaselRevision {
  id           String          @id @default(cuid())
  title        String          // e.g., "Perubahan 1", "Amendment 2024"
  content      String          @db.Text // The old/previous content
  revisionDate DateTime        // When this revision was made
  subsectionId String
  subsection   BaselSubsection @relation(fields: [subsectionId], references: [id], onDelete: Cascade)
  order        Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

// Recent updates log (manually managed by admin)
model BaselUpdate {
  id          String   @id @default(cuid())
  title       String
  description String?
  link        String?  // Optional link to chapter/section
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
}

// ============================================
// BetterBankings Angle (Podcast) Models
// ============================================

// Podcast Categories (e.g., Regulation, Risk Management, Digital Banking)
model PodcastCategory {
  id        String    @id @default(cuid())
  name      String    @unique
  order     Int       @default(0)
  podcasts  Podcast[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Main Podcast Episode
model Podcast {
  id          String           @id @default(cuid())
  label       String           // "Season 2 â€¢ Ep. 12" (flexible text)
  title       String
  description String           @db.Text
  date        DateTime
  duration    String           // "42 min"
  link        String           // Spotify/podcast link
  categoryId  String
  category    PodcastCategory  @relation(fields: [categoryId], references: [id])
  speakers    PodcastSpeaker[]
  topics      PodcastTopic[]
  order       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// Speaker with title (supports multiple per podcast)
model PodcastSpeaker {
  id        String   @id @default(cuid())
  name      String
  title     String   // "Chief Regulatory Officer, Regional Bank Association"
  podcastId String
  podcast   Podcast  @relation(fields: [podcastId], references: [id], onDelete: Cascade)
  order     Int      @default(0)
  createdAt DateTime @default(now())
}

// Topics/Tags for podcasts (supports multiple per podcast)
model PodcastTopic {
  id        String   @id @default(cuid())
  name      String   // "Basel IV", "Compliance", "Regional Banking"
  podcastId String
  podcast   Podcast  @relation(fields: [podcastId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// ============================================
// Notification System Models
// ============================================

// Notifications created by admin for all users
model Notification {
  id          String             @id @default(cuid())
  title       String
  description String             @db.Text
  category    String             // "Content", "Data", "Regulation"
  link        String?            // Optional redirect URL
  createdAt   DateTime           @default(now())
  userReads   UserNotification[]

  @@index([category])
  @@index([createdAt])
}

// Track read status per user
model UserNotification {
  id             String       @id @default(cuid())
  userId         String
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@unique([userId, notificationId])
  @@index([userId])
  @@index([userId, isRead])
}